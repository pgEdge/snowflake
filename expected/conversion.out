/*
 * A series of tests on transformation of serial and IDENTITY columns to the
 * Snowflake-default ones.
 */
\set VERBOSITY terse
SET snowflake.node = 1;
CREATE EXTENSION snowflake;
-- Need to check two types of serial values: DEFAULT and IDENTITY
CREATE TABLE t1(x serial);
CREATE TABLE t2 (x integer GENERATED ALWAYS AS IDENTITY);
CREATE TABLE t3 (x integer GENERATED BY DEFAULT AS IDENTITY,
				 y serial NOT NULL, z serial NOT NULL CHECK (y > 0));
CREATE SEQUENCE seq_1 START 42;
INSERT INTO t1 VALUES (DEFAULT);
INSERT INTO t2 VALUES (DEFAULT);
INSERT INTO t3 VALUES (DEFAULT);
SELECT snowflake.convert_sequence_to_snowflake('t1'); -- ERROR, not a sequence
ERROR:  Input value "public.t1" is not a valid convertable sequence
SELECT snowflake.convert_sequence_to_snowflake('seq_1'); -- No associated relation found
NOTICE:  ALTER SEQUENCE public.seq_1 NO CYCLE MAXVALUE 43
 convert_sequence_to_snowflake 
-------------------------------
                             0
(1 row)

SELECT snowflake.convert_sequence_to_snowflake('t1_x_seq');
NOTICE:  EXECUTE ALTER TABLE public.t1 ALTER COLUMN x SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t1 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.t1_x_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.t1_x_seq NO CYCLE MAXVALUE 2
 convert_sequence_to_snowflake 
-------------------------------
                             1
(1 row)

SELECT snowflake.convert_sequence_to_snowflake('t2_x_seq');
NOTICE:  Update pg_attribute: reset attidentity value for table public.t2, column x
NOTICE:  EXECUTE ALTER TABLE public.t2 ALTER COLUMN x SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t2 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.t2_x_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.t2_x_seq NO CYCLE MAXVALUE 2
 convert_sequence_to_snowflake 
-------------------------------
                             1
(1 row)

SELECT snowflake.convert_sequence_to_snowflake('t3_x_seq');
NOTICE:  Update pg_attribute: reset attidentity value for table public.t3, column x
NOTICE:  EXECUTE ALTER TABLE public.t3 ALTER COLUMN x SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t3 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.t3_x_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.t3_x_seq NO CYCLE MAXVALUE 2
 convert_sequence_to_snowflake 
-------------------------------
                             1
(1 row)

SELECT snowflake.convert_sequence_to_snowflake('t3_z_seq'); -- non-default attnum
NOTICE:  EXECUTE ALTER TABLE public.t3 ALTER COLUMN z SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t3 ALTER COLUMN z SET DEFAULT snowflake.nextval('public.t3_z_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.t3_z_seq NO CYCLE MAXVALUE 2
 convert_sequence_to_snowflake 
-------------------------------
                             1
(1 row)

INSERT INTO t1 VALUES (DEFAULT);
INSERT INTO t2 VALUES (DEFAULT);
INSERT INTO t3 VALUES (DEFAULT);
-- Check the result of conversion
SELECT x <= 42 AS is_not_snowflake_value FROM t1 ORDER BY x;
 is_not_snowflake_value 
------------------------
 t
 f
(2 rows)

SELECT x <= 42 AS is_not_snowflake_value FROM t2 ORDER BY x;
 is_not_snowflake_value 
------------------------
 t
 f
(2 rows)

SELECT
	x <= 42 AS is_not_snowflake_value,
	y,
	z <= 42 AS is_not_snowflake_value
FROM t3 ORDER BY x;
 is_not_snowflake_value | y | is_not_snowflake_value 
------------------------+---+------------------------
 t                      | 1 | t
 f                      | 2 | f
(2 rows)

ALTER TABLE t3 ALTER COLUMN y SET DEFAULT 1;
SELECT snowflake.convert_sequence_to_snowflake('t3_y_seq');
ERROR:  definition of DEFAULT value for column "y" of relation "t3" does not correspond serial or bigserial type: "1"
INSERT INTO t3 VALUES (DEFAULT);
SELECT
	x <= 42 AS is_not_snowflake_value,
	y,
	z <= 42 AS is_not_snowflake_value
FROM t3 ORDER BY x;
 is_not_snowflake_value | y | is_not_snowflake_value 
------------------------+---+------------------------
 t                      | 1 | t
 f                      | 2 | f
 f                      | 1 | f
(3 rows)

-- Manually set DEFAULT nextval for a column
ALTER TABLE t3 ALTER COLUMN y DROP DEFAULT;
SELECT snowflake.convert_sequence_to_snowflake('t3_y_seq'); -- Should be correctly ignored
ERROR:  definition of DEFAULT value for column "y" of relation "t3" does not correspond serial or bigserial type: "<NULL>"
ALTER TABLE t3 ALTER COLUMN y SET DEFAULT nextval('t3_y_seq'::regclass);
SELECT snowflake.convert_sequence_to_snowflake('t3_y_seq');
NOTICE:  EXECUTE ALTER TABLE public.t3 ALTER COLUMN y SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t3 ALTER COLUMN y SET DEFAULT snowflake.nextval('public.t3_y_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.t3_y_seq NO CYCLE MAXVALUE 3
 convert_sequence_to_snowflake 
-------------------------------
                             1
(1 row)

TRUNCATE t3;
INSERT INTO t3 VALUES (DEFAULT);
SELECT
	x <= 42 AS is_not_snowflake_value,
	y <= 42 AS is_not_snowflake_value,
	z <= 42 AS is_not_snowflake_value
FROM t3 ORDER BY x;
 is_not_snowflake_value | is_not_snowflake_value | is_not_snowflake_value 
------------------------+------------------------+------------------------
 f                      | f                      | f
(1 row)

-- Manual usage of the snowflake default is also legal.
ALTER TABLE t3 ALTER COLUMN y DROP DEFAULT;
ALTER TABLE t3 ALTER COLUMN y SET DEFAULT snowflake.nextval('t3_y_seq'::regclass);
SELECT snowflake.convert_sequence_to_snowflake('t3_y_seq'); -- do not convert, it is already done manually
ERROR:  definition of DEFAULT value for column "y" of relation "t3" does not correspond serial or bigserial type: "snowflake.nextval('public.t3_y_seq'::regclass)"
INSERT INTO t3 VALUES (DEFAULT);
SELECT
	x <= 42 AS is_not_snowflake_value,
	y <= 42 AS is_not_snowflake_value,
	z <= 42 AS is_not_snowflake_value
FROM t3 ORDER BY x;
 is_not_snowflake_value | is_not_snowflake_value | is_not_snowflake_value 
------------------------+------------------------+------------------------
 f                      | f                      | f
 f                      | f                      | f
(2 rows)

-- Explict default
CREATE SEQUENCE favorite_seq;
CREATE TABLE t4 (x integer DEFAULT nextval('favorite_seq'::regclass));
INSERT INTO t4 values (DEFAULT);
SELECT * FROM t4;
 x 
---
 1
(1 row)

SELECT snowflake.convert_sequence_to_snowflake('favorite_seq');
NOTICE:  EXECUTE ALTER TABLE public.t4 ALTER COLUMN x SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t4 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.favorite_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.favorite_seq NO CYCLE MAXVALUE 2
 convert_sequence_to_snowflake 
-------------------------------
                             2
(1 row)

INSERT INTO t4 values (DEFAULT);
SELECT x <= 42 AS is_not_snowflake_value FROM t4 ORDER BY x;
 is_not_snowflake_value 
------------------------
 t
 f
(2 rows)

-- Sequence, shared by two tables
DROP TABLE t4 CASCADE;
DROP SEQUENCE favorite_seq;
CREATE SEQUENCE favorite_seq;
CREATE TABLE t4 (x integer DEFAULT nextval('favorite_seq'::regclass));
INSERT INTO t4 values (DEFAULT);
CREATE TABLE t5 (x integer DEFAULT nextval('favorite_seq'::regclass));
INSERT INTO t5 values (DEFAULT);
SELECT * FROM t4;
 x 
---
 1
(1 row)

SELECT * FROM t5;
 x 
---
 2
(1 row)

SELECT snowflake.convert_sequence_to_snowflake('favorite_seq');
NOTICE:  EXECUTE ALTER TABLE public.t4 ALTER COLUMN x SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t4 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.favorite_seq'::regclass)
NOTICE:  EXECUTE ALTER TABLE public.t5 ALTER COLUMN x SET DATA TYPE int8
NOTICE:  EXECUTE ALTER TABLE public.t5 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.favorite_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.favorite_seq NO CYCLE MAXVALUE 3
 convert_sequence_to_snowflake 
-------------------------------
                             4
(1 row)

INSERT INTO t4 values (DEFAULT);
INSERT INTO t5 values (DEFAULT);
SELECT x AS sf_val FROM t4 WHERE x > 42 \gset
SELECT :sf_val < x AS is_growing FROM t5 WHERE x > 42;
 is_growing 
------------
 t
(1 row)

-- Test INCREMENT
CREATE TABLE t6(x bigserial, y int);
INSERT INTO t6 VALUES (DEFAULT, 10);
INSERT INTO t6 VALUES (DEFAULT, 20);
SELECT * FROM t6;
 x | y  
---+----
 1 | 10
 2 | 20
(2 rows)

INSERT INTO t6 VALUES (DEFAULT, 30);
SELECT * FROM t6;
 x | y  
---+----
 1 | 10
 2 | 20
 3 | 30
(3 rows)

SELECT snowflake.convert_sequence_to_snowflake('t6_x_seq');
NOTICE:  EXECUTE ALTER TABLE public.t6 ALTER COLUMN x SET DEFAULT snowflake.nextval('public.t6_x_seq'::regclass)
NOTICE:  ALTER SEQUENCE public.t6_x_seq NO CYCLE MAXVALUE 4
 convert_sequence_to_snowflake 
-------------------------------
                             0
(1 row)

-- Get the count portion of the id.
-- It happens within the same milisecond, should increment
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'));
 get_count 
-----------
         0
         1
         2
(3 rows)

-- Should return 1 (the counter difference)
SELECT ABS(snowflake.nextval('t6_x_seq') - snowflake.nextval('t6_x_seq'));
 abs 
-----
   1
(1 row)

-- If < 4096, will increment that amount
ALTER SEQUENCE t6_x_seq INCREMENT 100 NO MAXVALUE;
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'));
 get_count 
-----------
       104
       204
       304
(3 rows)

-- This will force the time ms portion to increment,
-- the count portion should be 0
ALTER SEQUENCE t6_x_seq INCREMENT 4096;
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'));
 get_count 
-----------
         0
         0
         0
(3 rows)

-- should return 1 (the ms difference)
SELECT ABS(snowflake.nextval('t6_x_seq') - snowflake.nextval('t6_x_seq')) >> 22;
 ?column? 
----------
        1
(1 row)

-- Test unreasonable value- still should get 0s
ALTER SEQUENCE t6_x_seq INCREMENT 9999;
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'))
UNION ALL
SELECT snowflake.get_count(snowflake.nextval('t6_x_seq'));
 get_count 
-----------
         0
         0
         0
(3 rows)

-- should return 1 (the ms difference)
SELECT ABS(snowflake.nextval('t6_x_seq') - snowflake.nextval('t6_x_seq')) >> 22;
 ?column? 
----------
        1
(1 row)

-- Cleanup
DROP TABLE t1,t2,t3,t4,t5,t6 CASCADE;
DROP SEQUENCE favorite_seq;
DROP EXTENSION snowflake;
